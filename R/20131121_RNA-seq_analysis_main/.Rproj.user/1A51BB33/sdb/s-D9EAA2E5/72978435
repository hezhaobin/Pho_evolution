{
    "contents" : "RNASeq_analysis | data: 11/13/2013\n========================================================\nThis script takes in raw counts and determine Differential Expression (DE) \nfor every gene of interest.\nData-wise, it combines the 06/15/2013 and 11/13/2013 data\nhebin\n18 nov 2013\nRead data\n------------------\n```{r Read_Data, message=FALSE, cache=TRUE}\nlibrary(limma)  # note: here the loading order is important. If limma is loaded last, it will mask the plotMA function\nlibrary(DESeq2) #       from DESeq2\nsetwd(\"~/Documents/work/Pho/Result/RNA-seq/main\")\n# Scer\nsc.sense <- read.csv(\"ScerRNAseq_sense.csv\",row.names=1)\n# sc.anti <- read.csv(\"ScerRNAseq_anti.csv\",row.names=1)\nsc.info <- read.table(\"ScerRNAseq_sample_info.txt\",col.names=c(\"Sample\",\"Genotype\", \"Size\"),as.is=TRUE)\nsc.genes <- rownames( sc.sense )\n\n# Cgla\ncg.sense <- read.csv(\"CglaRNAseq_sense.csv\",row.names=1)\n# cg.anti <- read.csv(\"CglaRNAseq_anti.csv\",row.names=1)\ncg.info <- read.table(\"CglaRNAseq_sample_info.txt\",col.names=c(\"Sample\",\"Genotype\",\"Size\"),as.is=TRUE)\ncg.genes <- rownames( cg.sense )\n\n# misc annotation stuff\n# convert Cgla genes to orthologs in Scer, based on orthogroup assignment from Aviv's database\n# note that for genes with more than one potential orthologs, the first one in the list is used\ncg.sc.ortholog <- read.table(\"Cgla-Scer-orthologs.txt\",na.string=\"NONE\",fill=TRUE,as.is=TRUE)\ncgToSc <- cg.sc.ortholog$V2; names(cgToSc) <- cg.sc.ortholog$V1\n\nsgdName <- read.table(\"sgdToName.txt\",as.is=TRUE)\nsgdToName <- sgdName$V2; names(sgdToName) <- sgdName$V1\nnameToSgd <- sgdName$V1; names(nameToSgd) <- sgdName$V2\n\nxu.genes <- c(\"PHO8\",\"VTC3\",\"SPL2\",\"PHO81\",\"PHO86\",\"PHO5\",\"PHO11\",\"PHO84\",\"PHO89\",\"PHM6\",\"PHO12\",\"GIT1\",\"VTC1\",\"VTC4\",\"CTF19\",\"YAR070C\",\"ENA2\",\"VTC2\",\"ENA1\",\"GDE1\",\"PHM8\",\"VIP1\",\"CBF1\",\"DDP1\",\"YJL119C\",\"HOR2\",\"YNL217W\")\nXu.genes <- nameToSgd[ xu.genes ]\nall.80 <-c(\"YAL005C\",\"YAR068W\",\"YAR070C\",\"YAR071W\",\"YBR072W\",\"YBR093C\",\"YBR157C\",\"YBR169C\",\"YBR296C\",\"YCL040W\",\"YCR098C\",\"YDL204W\",\"YDR005C\",\"YDR019C\",\"YDR039C\",\"YDR040C\",\"YDR270W\",\"YDR281C\",\"YDR481C\",\"YDR516C\",\"YEL011W\",\"YEL065W\",\"YER037W\",\"YER062C\",\"YER072W\",\"YFL004W\",\"YFR053C\",\"YGR233C\",\"YHL035C\",\"YHL040C\",\"YHL047C\",\"YHR136C\",\"YHR138C\",\"YHR214W-A\",\"YHR215W\",\"YIL074C\",\"YIL169C\",\"YJL012C\",\"YJL117W\",\"YJL119C\",\"YJR060W\",\"YKL001C\",\"YKR034W\",\"YKR080W\",\"YLL026W\",\"YLR109W\",\"YLR136C\",\"YLR142W\",\"YLR214W\",\"YLR303W\",\"YLR327C\",\"YLR410W\",\"YLR438W\",\"YML123C\",\"YML128C\",\"YMR011W\",\"YMR058W\",\"YMR105C\",\"YMR173W\",\"YMR173W-A\",\"YMR195W\",\"YMR251W\",\"YMR251W-A\",\"YNL217W\",\"YNR069C\",\"YOL086C\",\"YOL155C\",\"YOL158C\",\"YOR163W\",\"YOR173W\",\"YOR344C\",\"YOR347C\",\"YOR382W\",\"YOR383C\",\"YPL018W\",\"YPL019C\",\"YPL054W\",\"YPL110C\",\"YPR167C\")\n```\n\nUse DESeq\n------------------\n### 1. Subfunctions for calculating pairwiseDE\n```{r Subfunctions_4_DESeq, message=FALSE}\n# Function for calculating DE genes given the data, design \nPairwiseDE <- function( countTable, design, cond.A, cond.B ){\n  index.A <- which( design==cond.A )\n  index.B <- which( design==cond.B )\n  subTable <- countTable[, c(index.A,index.B)]\n  conditions <- factor( c(rep(cond.A,length(index.A)), rep(cond.B, length(index.B))) )\n  cds <- newCountDataSet( subTable, conditions )\n  cds <- estimateSizeFactors( cds )\n  cds <- estimateDispersions( cds )\n  res = nbinomTest( cds, cond.A, cond.B )\n  res1 <- res[ !is.na(res$padj), ]\n  return( res )\n}\n\n# Function to report significant genes at a given fdr and log2FoldChange threshold\nsigGene <- function( res, fdr=0.05, log2FoldChange=1, direction=\"up\", baseMean=0 ) {\n  par <- paste(\"sigGene --fdr=\", fdr, \" --foldchange=\", 2^log2FoldChange, \" --direction=\", direction, \" --baseMean=\",baseMean, sep=\"\", collapse=\"\")\n  if( direction != \"up\" & direction != \"down\" ){\n    list = rep(FALSE, nrow(res))\n  }\n  else if( direction == \"up\"){\n    list = res$padj < fdr & res$log2FoldChange > log2FoldChange & res$baseMean > baseMean\n  }\n  else if( direction == \"down\"){\n    list = res$padj < fdr & res$log2FoldChange < -log2FoldChange & res$baseMean > baseMean\n  }\n  list = replace(list, is.na(list), FALSE)\n  attr(list, \"par\") <- par\n  cat( par )\n  return( list )\n}\n# Use DESeq2 to call significantly DE genes\nPairwiseDE2 <- function( countTable, design, cond.A, cond.B ){\n  index.A <- which( design==cond.A )\n  index.B <- which( design==cond.B )\n  subTable <- countTable[, c(index.A,index.B)]\n  conditions <- factor( c(rep(cond.A,length(index.A)), rep(cond.B, length(index.B))), levels=c(cond.A,cond.B) )\n  colData <- DataFrame( condition = conditions )\n  dds <- DESeqDataSetFromMatrix( countData = subTable, colData = colData, design = ~condition)\n  dds <- DESeq( dds )\n  return( dds )\n}\n# Compare two lists\ncompList <- function(listA, listB, total=0){\n  res <- list(common = intersect(listA, listB), A.only = setdiff(listA, listB), B.only = setdiff(listB, listA))\n  len <- sapply(res, length)\n  cat(paste(c(\"In both\",\" A only\",\" B only\"), len, sep=\":\", collapse=\"\\n\"))\n  if( total ) { # if total # of genes is given, calculate the enrichment factor and p-value from hypergeometric dist.\n    expect <- length(listB) / total * length(listA)\n    enrich <- round( len[\"common\"] / expect, 1 )\n    p.hypergeom <- phyper(q=len[\"common\"],m=length(listB),n=total-length(listB),k=length(listA),lower.tail=F)\n    cat(\"\\n\\n\")\n    cat( sprintf( \"Enrichment factor: %.1f\\np< %.2g\", enrich, p.hypergeom ) )\n  }\n  return(res)\n}\n```\n\n### 2. Actual analysis of the data\n#### 2.1 Compare scPho4 targets in _pho80_ vs. under starvation\n_Question: what genes are regulated in common vs. differently?_\n```{r pho80_vs_starve_Scer, cache=TRUE, message=FALSE, echo=FALSE, fig.width=10, fig.height=5 }\n# Identify genes in pho80\ncat(\"Identify genes in pho80_del in Scer...\")\n# naming conventions: species.pho4.comment.object\ndds <- list( sc.sc4.no80 = PairwiseDE2( sc.sense, sc.info$Genotype, \"wt.highPi\", \"pho80\" ) )\nres <- list( sc.sc4.no80 = results(dds[[1]]) )\nsig <- list( sc.sc4.no80 = sigGene(res$sc.sc4.no80,baseMean=100) )\nsigd <- list( sc.sc4.no80 = sigGene(res$sc.sc4.no80,direction=\"down\",baseMean=100) )\ngene <- list( sc.sc4.no80 = sc.genes[ sig$sc.sc4.no80 ] )\n# Identify genes under starvation\ncat(\"Identify genes under starvation in Scer...\")\ndds$sc.sc4.noPi <- PairwiseDE2( sc.sense, sc.info$Genotype, \"wt.highPi\", \"wt.lowPi\")\nres$sc.sc4.noPi <- results(dds[[2]])\nsig$sc.sc4.noPi <- sigGene(res[[2]], baseMean=100)\nsigd$sc.sc4.noPi <- sigGene(res[[2]], direction=\"down\", baseMean=100)\ngene$sc.sc4.noPi = sc.genes[ sig$sc.sc4.noPi ]\n# compare pho80 and starvation\ncomp <- list( sc.sc4.no80_noPi = table( \"pho80\"=sig[[1]], \"noPi\"=sig[[2]] ) )\ncat(\"Compare pho80- and Pi starvation genes\")\nprint( addmargins(comp[[1]]) ) # print overlaps\nlayout(matrix(1:2,ncol=2)) # MA plots.\nplotMA( dds$sc.sc4.no80, pvalCutoff=.05, main=\"pho80 bg\");abline(v=100,h=1,lty=2)\nplotMA( dds$sc.sc4.noPi, pvalCutoff=.05, main=\"Pi starve\");abline(v=100,h=1,lty=2)\ncat( \"Genes defined by Xu and found in starvation conditions ...\")\ntmp <- compList( gene$sc.sc4.no80, gene$sc.sc4.noPi, 6603 )\ngene.list <- cbind( sig$sc.sc4.no80, sig$sc.sc4.noPi, FALSE )\nrownames(gene.list) <- sc.genes; colnames(gene.list) <- c(\"pho80\", \"no Pi\", \"Xu Pho4-genes\")\ngene.list[ Xu.genes, 3 ] <- TRUE\nvennCounts <- vennCounts(gene.list)\nvennDiagram( vennCounts, circle.col=c(\"black\",\"blue\",\"green\") )\n```\n\n",
    "created" : 1384897789684.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3323595478",
    "id" : "72978435",
    "lastKnownWriteTime" : 1385062370,
    "path" : "~/Documents/work/Pho/Result/RNA-seq/Main/RNASeq_analysis.Rmd",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_markdown"
}